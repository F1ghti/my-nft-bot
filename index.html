<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NFT Universe</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background: #0b1120; color: white; overflow: hidden; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        #main-slider { display: flex; transition: transform 0.4s cubic-bezier(0.2, 0, 0.2, 1); width: 400%; }
        .tab-content { width: 100vw; height: calc(100vh - 120px); overflow-y: auto; padding: 20px; flex-shrink: 0; }
        
        /* –†—É–ª–µ—Ç–∫–∞ */
        #roulette-wrap { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; flex-direction: column; }
        .window { width: 100%; height: 130px; overflow: hidden; position: relative; border-y: 2px solid #3b82f6; background: #111827; }
        .line { position: absolute; left: 50%; top: 0; bottom: 0; width: 3px; background: #f59e0b; z-index: 10; transform: translateX(-50%); }
        #list { display: flex; position: absolute; left: 0; transition: transform 4s cubic-bezier(0.1, 0, 0.1, 1); }
        
        .nav-btn { opacity: 0.4; font-size: 24px; transition: 0.3s; }
        .nav-btn.active { opacity: 1; transform: scale(1.2); }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div id="roulette-wrap">
        <h2 class="text-xl font-bold mb-8 text-blue-400 animate-pulse">–û–¢–ö–†–´–í–ê–ï–ú –ö–ï–ô–°...</h2>
        <div class="window">
            <div class="line"></div>
            <div id="list"></div>
        </div>
    </div>

    <div id="win-modal" class="fixed inset-0 bg-black/90 z-[2000] hidden items-center justify-center p-6">
        <div class="glass p-8 rounded-[40px] w-full max-w-sm text-center border-t-4 border-yellow-500">
            <div id="win-img"></div>
            <h3 id="win-name" class="text-2xl font-black my-4"></h3>
            <button onclick="location.reload()" class="w-full bg-blue-600 py-4 rounded-2xl font-bold">–û–¢–õ–ò–ß–ù–û</button>
        </div>
    </div>

    <div class="p-4 flex justify-between items-center glass m-2 rounded-3xl z-50">
        <div class="flex items-center gap-3">
            <img id="u-pic" class="w-10 h-10 rounded-full border-2 border-blue-500 hidden">
            <div id="u-no-pic" class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold">?</div>
            <p id="u-name" class="font-bold text-sm">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
        <p id="balance" class="text-yellow-400 font-black text-xl">0 üíé</p>
    </div>

    <div class="flex-1 overflow-hidden">
        <div id="main-slider">
            <div class="tab-content flex flex-col items-center justify-center">
                <div class="mb-6 text-center">
                    <img src="https://cdn-icons-png.flaticon.com/512/6585/6585144.png" class="w-48 h-48 mx-auto mb-4 drop-shadow-[0_0_20px_rgba(59,130,246,0.5)]">
                    <h2 class="text-3xl font-black italic">CYBER CASE</h2>
                </div>
                <button onclick="startSpin()" class="glass px-12 py-5 rounded-full text-2xl font-black border-b-4 border-blue-600 active:translate-y-1">100 üíé</button>
            </div>
            
            <div class="tab-content">
                <h2 class="text-xl font-bold mb-4">üõí –ú–ê–†–ö–ï–¢–ü–õ–ï–ô–°</h2>
                <div id="market-items" class="space-y-3"></div>
            </div>

            <div class="tab-content">
                <h2 class="text-xl font-bold mb-4">üéí –ú–û–ò NFT</h2>
                <div id="inv-grid" class="grid grid-cols-2 gap-3"></div>
            </div>

            <div class="tab-content">
                <h2 class="text-xl font-bold mb-4 text-yellow-500">üèÜ –¢–û–ü –õ–ò–î–ï–†–û–í</h2>
                <div id="top-list" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <div class="h-24 glass flex justify-around items-center px-4 rounded-t-[40px]">
        <button onclick="goToTab(0)" id="btn-0" class="nav-btn active">üì¶</button>
        <button onclick="goToTab(1)" id="btn-1" class="nav-btn">üõí</button>
        <button onclick="goToTab(2)" id="btn-2" class="nav-btn">üéí</button>
        <button onclick="goToTab(3)" id="btn-3" class="nav-btn">üèÜ</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const SERVER_URL = "https://12eaff4f4782.ngrok-free.app";
        const user = tg.initDataUnsafe.user || { id: 1, first_name: "Admin" };

        async function api(path, body = null) {
            const opt = { headers: {"Content-Type": "application/json", "ngrok-skip-browser-warning": "1"}};
            if(body) { opt.method = 'POST'; opt.body = JSON.stringify(body); }
            return fetch(SERVER_URL + path, opt).then(r => r.json());
        }

        async function sync() {
            const d = await api(`/get_user?user_id=${user.id}&username=${user.first_name}&photo_url=${user.photo_url || ''}`);
            document.getElementById('balance').innerText = d.balance + " üíé";
            document.getElementById('u-name').innerText = user.first_name;
            
            // –§–∏–∫—Å –∞–≤–∞—Ç–∞—Ä–∫–∏
            if(user.photo_url) {
                document.getElementById('u-pic').src = user.photo_url;
                document.getElementById('u-pic').classList.remove('hidden');
                document.getElementById('u-no-pic').classList.add('hidden');
            }

            const grid = document.getElementById('inv-grid');
            grid.innerHTML = d.inventory.map(item => `
                <div class="glass p-4 rounded-3xl text-center">
                    <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${item}" class="w-16 h-16 mx-auto mb-2">
                    <p class="text-[10px] font-bold mb-2">${item}</p>
                    <div class="flex flex-col gap-1">
                        <button onclick="api('/sell_instantly', {user_id:${user.id}, item_name:'${item}'}).then(sync)" class="bg-green-600/20 text-[8px] py-1 rounded-lg">–ë–û–¢–£ (80üíé)</button>
                        <button onclick="listMarket('${item}')" class="bg-blue-600 text-[8px] py-1 rounded-lg">–ù–ê –ú–ê–†–ö–ï–¢</button>
                    </div>
                </div>
            `).join('');
        }

        async function listMarket(item) {
            const price = prompt("–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –Ω–∞ –º–∞—Ä–∫–µ—Ç–µ:", "150");
            if(price) await api('/list_on_market', {user_id: user.id, item_name: item, price: price}).then(sync);
        }

        async function startSpin() {
            const res = await api('/open_case', {user_id: user.id});
            if(!res.success) return alert("–ú–∞–ª–æ –∫–∞–º–Ω–µ–π!");

            const wrap = document.getElementById('roulette-wrap');
            const list = document.getElementById('list');
            wrap.style.display = 'flex';
            list.innerHTML = '';
            
            const pool = ["Neon NFT", "Gold NFT", "Cyber Sword", "Void Armor", "Ice Ring", "Flame Wings"];
            for(let i=0; i<40; i++) {
                const name = i === 35 ? res.item : pool[Math.floor(Math.random()*pool.length)];
                list.innerHTML += `<div class="min-w-[100px] h-[100px] glass m-2 rounded-xl flex items-center justify-center shrink-0"><img src="https://api.dicebear.com/7.x/bottts/svg?seed=${name}" class="w-16 h-16"></div>`;
            }

            setTimeout(() => {
                list.style.transform = `translateX(-${35 * 116 - window.innerWidth/2 + 58}px)`;
            }, 100);

            setTimeout(() => {
                wrap.style.display = 'none';
                document.getElementById('win-modal').style.display = 'flex';
                document.getElementById('win-name').innerText = res.item;
                document.getElementById('win-img').innerHTML = `<img src="https://api.dicebear.com/7.x/bottts/svg?seed=${res.item}" class="w-32 h-32 mx-auto">`;
            }, 4500);
        }

        async function goToTab(i) {
            document.getElementById('main-slider').style.transform = `translateX(-${i * 100}vw)`;
            document.querySelectorAll('.nav-btn').forEach((b, idx) => b.classList.toggle('active', idx === i));
            if(i === 1) {
                const m = await api('/get_market');
                document.getElementById('market-items').innerHTML = m.map(item => `
                    <div class="glass p-4 rounded-2xl flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${item.item_name}" class="w-10 h-10">
                            <div><p class="font-bold text-xs">${item.item_name}</p><p class="text-[10px] text-gray-400">–æ—Ç ${item.username}</p></div>
                        </div>
                        <button class="bg-yellow-500 text-black px-4 py-2 rounded-xl font-bold text-xs">${item.price} üíé</button>
                    </div>
                `).join('');
            }
            if(i === 3) {
                const t = await api('/get_top');
                document.getElementById('top-list').innerHTML = t.map((u, idx) => `
                    <div class="glass p-3 rounded-xl flex justify-between">
                        <span>#${idx+1} ${u.username}</span>
                        <span class="text-yellow-400 font-bold">${u.balance}</span>
                    </div>
                `).join('');
            }
        }

        sync();
    </script>
</body>
</html>
