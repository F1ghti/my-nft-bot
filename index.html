<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NFT Universe Elite</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0b1120; color: white; overflow: hidden; height: 100vh; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); }
        
        #main-slider { display: flex; transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); width: 400%; height: calc(100vh - 180px); }
        .tab-content { width: 100vw; height: 100%; overflow-y: auto; padding: 20px; flex-shrink: 0; }
        
        #roulette-wrap { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; align-items: center; justify-content: center; flex-direction: column; }
        .roulette-window { width: 100%; height: 140px; overflow: hidden; position: relative; border-top: 2px solid #3b82f6; border-bottom: 2px solid #3b82f6; background: #111827; }
        .roulette-marker { position: absolute; left: 50%; top: 0; bottom: 0; width: 4px; background: #f59e0b; z-index: 10; transform: translateX(-50%); box-shadow: 0 0 15px #f59e0b; }
        #roulette-list { display: flex; position: absolute; left: 0; transition: transform 4s cubic-bezier(0.15, 0, 0.05, 1); }

        .nav-btn { opacity: 0.4; transition: 0.3s; display: flex; flex-direction: column; align-items: center; }
        .nav-btn.active { opacity: 1; filter: drop-shadow(0 0 8px #3b82f6); }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; align-items: center; justify-content: center; padding: 20px; }
    </style>
</head>
<body class="flex flex-col">

    <div id="preview-modal" class="modal" onclick="this.style.display='none'">
        <div class="glass p-6 rounded-[35px] w-full max-w-sm" onclick="event.stopPropagation()">
            <h2 class="text-xl font-bold mb-4 text-blue-400 uppercase italic">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–µ–π—Å–∞</h2>
            <div id="preview-list" class="grid grid-cols-2 gap-3 max-h-[60vh] overflow-y-auto"></div>
            <button onclick="document.getElementById('preview-modal').style.display='none'" class="w-full mt-6 py-4 bg-white/10 rounded-2xl font-bold uppercase">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <div id="roulette-wrap">
        <h2 class="text-xl font-black mb-8 text-blue-400 tracking-widest animate-pulse">–ì–ï–ù–ï–†–ê–¶–ò–Ø NFT...</h2>
        <div class="roulette-window">
            <div class="roulette-marker"></div>
            <div id="roulette-list"></div>
        </div>
    </div>

    <div id="win-modal" class="modal">
        <div class="glass p-8 rounded-[40px] w-full max-w-sm text-center border-t-4 border-yellow-500 shadow-2xl">
            <h2 class="text-2xl font-black text-yellow-500 uppercase italic">–¢–≤–æ–π –ø—Ä–∏–∑!</h2>
            <div id="win-img" class="my-6"></div>
            <h3 id="win-name" class="text-xl font-bold mb-6 text-white">...</h3>
            <button onclick="closeWin()" class="w-full bg-blue-600 py-5 rounded-[25px] font-black text-xl shadow-lg active:scale-95 transition-all uppercase italic">–í —Ä—é–∫–∑–∞–∫</button>
        </div>
    </div>

 <div class="p-4 flex justify-between items-center glass m-4 rounded-3xl z-50">
        <div class="flex items-center gap-3">
            <img id="u-pic" class="w-10 h-10 rounded-full border-2 border-blue-500 hidden">
            <div id="u-no-pic" class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center font-bold text-xs shadow-lg">?</div>
            <div>
                <p id="u-name" class="font-bold text-sm leading-none">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                <p class="text-[9px] text-blue-400 font-bold uppercase mt-1">Elite Member</p>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <div class="relative active:scale-90 transition-all cursor-pointer" onclick="tg.showAlert('–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π')">
                <span class="text-xl">üîî</span>
                <span class="absolute -top-1 -right-1 bg-red-500 w-2 h-2 rounded-full border border-[#0b1120] animate-ping"></span>
                <span class="absolute -top-1 -right-1 bg-red-500 w-2 h-2 rounded-full border border-[#0b1120]"></span>
            </div>
            
            <div class="text-right">
                <p id="balance" class="text-yellow-400 font-black text-xl drop-shadow-[0_0_8px_rgba(250,204,21,0.4)]">0 üíé</p>
            </div>
        </div>
    </div>

    <div id="main-slider">
        <div class="tab-content flex flex-col items-center justify-center">
            <div class="relative group" onclick="showPreview()">
                <div class="absolute -inset-4 bg-blue-500/20 blur-3xl rounded-full"></div>
                <img src="https://cdn-icons-png.flaticon.com/512/6585/6585144.png" class="w-56 h-56 relative z-10 drop-shadow-2xl animate-bounce" style="animation-duration: 3s">
                <div class="absolute bottom-0 right-0 bg-blue-600 p-2 rounded-full z-20 shadow-lg border-2 border-white/20">
                    <span class="text-xs">üîç</span>
                </div>
            </div>
            <h2 class="text-3xl font-black italic mt-6 tracking-tighter uppercase">Cyber Case</h2>
            <p class="text-gray-500 text-xs mb-8 uppercase font-bold tracking-widest">–ù–∞–∂–º–∏ –Ω–∞ –∫–µ–π—Å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥—Ä–æ–ø</p>
            <button onclick="startSpin()" class="bg-blue-600 px-16 py-5 rounded-[30px] text-2xl font-black shadow-[0_10px_20px_rgba(37,99,235,0.4)] active:translate-y-1 transition-all">100 üíé</button>
        </div>
        
        <div class="tab-content">
            <h2 class="text-2xl font-black mb-6 italic text-blue-400">üõí –ú–ê–†–ö–ï–¢–ü–õ–ï–ô–°</h2>
            <div id="market-items" class="space-y-3">
                <p class="text-center text-gray-500 py-20 italic">–ù–∞ —Ä—ã–Ω–∫–µ –ø–æ–∫–∞ –ø—É—Å—Ç–æ...</p>
            </div>
        </div>

        <div class="tab-content">
            <h2 class="text-2xl font-black mb-6 italic text-blue-400">üéí –¢–í–û–ò –ê–ö–¢–ò–í–´</h2>
            <div id="inv-grid" class="grid grid-cols-2 gap-4"></div>
        </div>

        <div class="tab-content">
            <h2 class="text-2xl font-black mb-6 italic text-yellow-500">üèÜ –¢–û–ü –≠–õ–ò–¢–´</h2>
            <div id="top-list" class="space-y-3"></div>
        </div>
    </div>

    <div class="fixed bottom-6 left-6 right-6 h-20 glass rounded-[35px] flex justify-around items-center z-[1000] px-4">
        <button onclick="goToTab(0)" id="btn-0" class="nav-btn active">
            <span class="text-2xl">üì¶</span>
        </button>
        <button onclick="goToTab(1)" id="btn-1" class="nav-btn">
            <span class="text-2xl">üõí</span>
        </button>
        <button onclick="goToTab(2)" id="btn-2" class="nav-btn">
            <span class="text-2xl">üéí</span>
        </button>
        <button onclick="goToTab(3)" id="btn-3" class="nav-btn">
            <span class="text-2xl">üèÜ</span>
        </button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        const SERVER_URL = "https://12eaff4f4782.ngrok-free.app"; 
        const user = tg.initDataUnsafe.user || { id: 12345, first_name: "Player" };

        async function api(path, body = null) {
            try {
                const opt = { 
                    headers: {"Content-Type": "application/json", "ngrok-skip-browser-warning": "1"}
                };
                if(body) { opt.method = 'POST'; opt.body = JSON.stringify(body); }
                const res = await fetch(SERVER_URL + path, opt);
                return await res.json();
            } catch(e) { console.error("API Error:", e); return {success: false}; }
        }

        function openItemMenu(name) {
            tg.HapticFeedback.impactOccurred('medium');
            tg.showPopup({
                title: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ NFT',
                message: `–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å —Å ${name}?`,
                buttons: [
                    {id: 'to_market', type: 'default', text: '–í—ã—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –º–∞—Ä–∫–µ—Ç'},
                    {id: 'to_bot', type: 'destructive', text: '–ü—Ä–æ–¥–∞—Ç—å –±–æ—Ç—É (–±—ã—Å—Ç—Ä–æ)'},
                    {id: 'cancel', type: 'cancel', text: '–û—Ç–º–µ–Ω–∞'}
                ]
            }, async (btnId) => {
                if (btnId === 'to_bot') {
                    const res = await api('/sell_instantly', {user_id: user.id, item_name: name});
                    if(res.success) { tg.showAlert("‚úÖ –ü—Ä–æ–¥–∞–Ω–æ!"); sync(); }
                } else if (btnId === 'to_market') {
                    setTimeout(() => {
                        const price = prompt(`–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É (üíé) –∑–∞ ${name}:`, "200");
                        if (price && !isNaN(price) && parseInt(price) > 0) {
                            processMarketListing(name, parseInt(price));
                        }
                    }, 100);
                }
            });
        }

        async function processMarketListing(name, price) {
            const res = await api('/list_on_market', {user_id: user.id, item_name: name, price: price});
            if(res.success) {
                tg.showAlert(`üöÄ –í—ã—Å—Ç–∞–≤–ª–µ–Ω–æ –∑–∞ ${price} üíé`);
                sync();
            }
        }

        async function buyItem(lotId, price) {
            tg.showConfirm(`–ö—É–ø–∏—Ç—å –∑–∞ ${price} üíé?`, async (yes) => {
                if (yes) {
                    const res = await api('/buy_item', {user_id: user.id, lot_id: lotId});
                    if(res.success) {
                        tg.showAlert("üéâ –ö—É–ø–ª–µ–Ω–æ!");
                        sync(); loadMarket();
                    } else { tg.showAlert("‚ùå " + res.error); }
                }
            });
        }

        // --- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –û–¢–ú–ï–ù–´ –õ–û–¢–ê ---
        async function cancelLot(lotId) {
            tg.showConfirm("–°–Ω—è—Ç—å –ø—Ä–µ–¥–º–µ—Ç —Å –ø—Ä–æ–¥–∞–∂–∏?", async (yes) => {
                if (yes) {
                    const res = await api('/cancel_lot', {user_id: user.id, lot_id: lotId});
                    if (res.success) {
                        tg.showAlert("–ü—Ä–µ–¥–º–µ—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω –≤ —Ä—é–∫–∑–∞–∫");
                        loadMarket();
                        sync();
                    } else {
                        tg.showAlert("–û—à–∏–±–∫–∞: " + res.error);
                    }
                }
            });
        }

        async function sync() {
            const d = await api(`/get_user?user_id=${user.id}&username=${encodeURIComponent(user.first_name)}&photo_url=${encodeURIComponent(user.photo_url || '')}`);
            document.getElementById('balance').innerText = d.balance.toLocaleString() + " üíé";
            document.getElementById('u-name').innerText = user.first_name;
            
            if(user.photo_url) {
                const pic = document.getElementById('u-pic');
                pic.src = user.photo_url; pic.classList.remove('hidden');
                document.getElementById('u-no-pic').classList.add('hidden');
            }

            const grid = document.getElementById('inv-grid');
            if(d.inventory.length === 0) {
                grid.innerHTML = '<p class="col-span-2 text-center text-gray-500 py-20 italic">–†—é–∫–∑–∞–∫ –ø—É—Å—Ç</p>';
            } else {
                grid.innerHTML = d.inventory.map(item => `
                    <div onclick="openItemMenu('${item}')" class="glass p-4 rounded-[30px] text-center border-b-4 border-blue-500/30 active:scale-90 transition-all cursor-pointer">
                        <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${item}" class="w-20 h-20 mx-auto mb-2">
                        <p class="text-[10px] font-black uppercase mb-1 truncate">${item}</p>
                        <p class="text-[8px] text-blue-400 font-bold uppercase">–ú–µ–Ω—é</p>
                    </div>
                `).join('');
            }
        }

        // --- –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ú–ê–†–ö–ï–¢ –° –ö–ù–û–ü–ö–û–ô "–°–ù–Ø–¢–¨" ---
        async function loadMarket() {
            const items = await api('/get_market');
            const container = document.getElementById('market-items');
            if(items.length > 0) {
                container.innerHTML = items.map(i => `
                    <div class="glass p-4 rounded-2xl flex justify-between items-center border-l-4 ${i.seller_id == user.id ? 'border-blue-500 shadow-[0_0_10px_rgba(59,130,246,0.2)]' : 'border-yellow-500'}">
                        <div class="flex items-center gap-3">
                            <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${i.item_name}" class="w-10 h-10">
                            <div>
                                <p class="text-[10px] font-bold uppercase">${i.item_name}</p>
                                <p class="text-[8px] text-blue-400">${i.seller_id == user.id ? '–í–∞—à –ª–æ—Ç' : '@' + i.username}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            ${i.seller_id == user.id ? 
                                `<button onclick="cancelLot(${i.lot_id})" class="bg-red-500/20 text-red-400 px-3 py-2 rounded-xl font-bold text-[10px] active:scale-95 border border-red-500/30">–°–ù–Ø–¢–¨</button>` : 
                                `<button onclick="buyItem(${i.lot_id}, ${i.price})" class="bg-yellow-500 text-black px-4 py-2 rounded-xl font-bold text-xs active:scale-95">${i.price} üíé</button>`
                            }
                            ${i.seller_id == user.id ? `<span class="text-xs font-bold text-gray-400 ml-1">${i.price} üíé</span>` : ''}
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p class="text-center text-gray-500 py-20 italic">–ù–∞ —Ä—ã–Ω–∫–µ –ø–æ–∫–∞ –ø—É—Å—Ç–æ...</p>';
            }
        }

        async function showPreview() {
            const info = await api('/get_case_info');
            const list = document.getElementById('preview-list');
            list.innerHTML = info.items.map(i => `
                <div class="bg-white/5 p-3 rounded-2xl text-center border border-white/5">
                    <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${i.name}" class="w-12 h-12 mx-auto mb-1">
                    <p class="text-[8px] font-bold uppercase truncate">${i.name}</p>
                </div>
            `).join('');
            document.getElementById('preview-modal').style.display = 'flex';
        }

        async function startSpin() {
            const res = await api('/open_case', {user_id: user.id});
            if(!res.success) { return alert("–ú–∞–ª–æ üíé"); }
            tg.HapticFeedback.impactOccurred('heavy');
            const wrap = document.getElementById('roulette-wrap');
            const list = document.getElementById('roulette-list');
            wrap.style.display = 'flex';
            list.innerHTML = '';
            list.style.transition = 'none';
            list.style.transform = 'translateX(0)';
            const info = await api('/get_case_info');
            const itemsPool = info.items.map(i => i.name);
            for(let i=0; i<50; i++) {
                const name = (i === 40) ? res.item : itemsPool[Math.floor(Math.random()*itemsPool.length)];
                list.innerHTML += `<div class="min-w-[120px] h-[120px] glass m-[5px] rounded-3xl flex items-center justify-center shrink-0"><img src="https://api.dicebear.com/7.x/bottts/svg?seed=${name}" class="w-20 h-20"></div>`;
            }
            setTimeout(() => {
                list.style.transition = 'transform 4s cubic-bezier(0.15, 0, 0.05, 1)';
                const shift = (40 * 130) - (window.innerWidth / 2) + 65;
                list.style.transform = `translateX(-${shift}px)`;
            }, 50);
            setTimeout(() => {
                wrap.style.display = 'none';
                document.getElementById('win-modal').style.display = 'flex';
                document.getElementById('win-name').innerText = res.item;
                document.getElementById('win-img').innerHTML = `<img src="https://api.dicebear.com/7.x/bottts/svg?seed=${res.item}" class="w-40 h-40 mx-auto">`;
            }, 4500);
        }

        function closeWin() { document.getElementById('win-modal').style.display = 'none'; sync(); }

        function goToTab(idx) {
            document.getElementById('main-slider').style.transform = `translateX(-${idx * 100}vw)`;
            document.querySelectorAll('.nav-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
            if(idx === 1) loadMarket();
            if(idx === 3) loadTop();
        }

        async function loadTop() {
            const top = await api('/get_top');
            document.getElementById('top-list').innerHTML = top.map((u, i) => `
                <div class="glass p-4 rounded-2xl flex justify-between items-center">
                    <p class="text-sm font-bold">#${i+1} ${u.username}</p>
                    <p class="text-yellow-400 font-black text-sm">${u.balance.toLocaleString()} üíé</p>
                </div>
            `).join('');
        }

        sync();
    </script>
</body>
</html>



