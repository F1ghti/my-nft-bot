<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NFT Universe Premium</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Inter:wght@300;700&display=swap');

        body { 
            font-family: 'Inter', sans-serif; 
            background: radial-gradient(circle at top right, #1e293b, #0f172a, #020617);
            color: white; overflow: hidden; height: 100vh; margin: 0;
        }

        /* –≠—Ñ—Ñ–µ–∫—Ç —Å–≤–µ—á–µ–Ω–∏—è –Ω–∞ —Ñ–æ–Ω–µ */
        .bg-glow {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: url('https://www.transparenttextures.com/patterns/carbon-fibre.png');
            opacity: 0.1; z-index: -1;
        }

        .glass { 
            background: rgba(30, 41, 59, 0.6); 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è —Å–ª–∞–π–¥–µ—Ä–∞ */
        #main-slider { display: flex; transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1); width: 400%; height: calc(100vh - 180px); }
        .tab-content { width: 100vw; height: 100%; overflow-y: auto; padding: 20px 20px 120px 20px; flex-shrink: 0; }

        /* –°—Ç–∏–ª–∏ —Ä–µ–¥–∫–æ—Å—Ç–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ */
        .card-Common { border-bottom: 4px solid #94a3b8; }
        .card-Rare { border-bottom: 4px solid #3b82f6; box-shadow: 0 4px 15px -5px #3b82f6; }
        .card-Epic { border-bottom: 4px solid #a855f7; box-shadow: 0 4px 20px -5px #a855f7; }
        .card-Legendary { border-bottom: 4px solid #facc15; animation: gold-glow 2s infinite; }
        .card-Mythic { border-bottom: 4px solid #f43f5e; animation: mythic-glow 1.5s infinite; }

        @keyframes gold-glow { 0%, 100% { box-shadow: 0 0 10px #facc15; } 50% { box-shadow: 0 0 25px #facc15; } }
        @keyframes mythic-glow { 0%, 100% { box-shadow: 0 0 15px #f43f5e; } 50% { box-shadow: 0 0 35px #f43f5e; } }

        /* –ö–∞—Å–∫–∞–¥–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
        .fade-in { animation: fadeIn 0.5s ease-out forwards; opacity: 0; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* –†—É–ª–µ—Ç–∫–∞ */
        .roulette-wrapper { position: relative; width: 100%; height: 140px; overflow: hidden; display: none; margin-bottom: 20px; }
        .roulette-track { display: flex; position: absolute; left: 0; align-items: center; }
        .roulette-item { width: 110px; height: 130px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .pointer { position: absolute; left: 50%; top: 0; bottom: 0; width: 4px; background: #facc15; z-index: 20; box-shadow: 0 0 20px #facc15; transform: translateX(-50%); }

        .nav-btn { opacity: 0.3; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); font-size: 24px; }
        .nav-btn.active { opacity: 1; transform: scale(1.3) translateY(-5px); filter: drop-shadow(0 0 10px #3b82f6); }
        
        .modal-full { display: none; position: fixed; inset: 0; z-index: 100; background: rgba(2, 6, 23, 0.9); backdrop-filter: blur(15px); }
        .selected-for-craft { border: 2px solid #a855f7 !important; background: rgba(168, 85, 247, 0.2) !important; transform: scale(0.95); }
    </style>
</head>
<body>
    <div class="bg-glow"></div>

    <div class="p-4 flex justify-between items-center glass m-4 rounded-[2.5rem] z-50">
        <div class="flex items-center gap-3">
            <img id="u-avatar" src="" class="w-11 h-11 rounded-full border-2 border-blue-500/50 object-cover bg-slate-800">
            <div>
                <p id="u-name" class="font-black text-xs uppercase tracking-widest italic">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                <div class="flex items-center gap-1">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <p class="text-[8px] text-blue-400 font-bold uppercase">Pro Trader</p>
                </div>
            </div>
        </div>
        <div class="text-right">
            <p id="balance" class="text-yellow-400 font-black text-2xl drop-shadow-[0_0_10px_rgba(250,204,21,0.3)]">0 üíé</p>
        </div>
    </div>

    <div id="main-slider">
        <div class="tab-content flex flex-col items-center justify-center">
            <div id="roulette-box" class="roulette-wrapper glass rounded-[2rem]">
                <div class="pointer"></div>
                <div id="roulette-track" class="roulette-track"></div>
            </div>
            
            <div id="case-ui" class="flex flex-col items-center">
                <div class="relative mb-8 group active:scale-90 transition-transform cursor-pointer" onclick="openCaseModal()">
                    <div class="absolute inset-0 bg-blue-500/20 blur-3xl rounded-full"></div>
                    <img src="https://api.dicebear.com/7.x/shapes/svg?seed=case9" class="w-56 h-56 drop-shadow-[0_35px_35px_rgba(0,0,0,0.5)] relative">
                    <div class="absolute -bottom-2 -right-2 bg-blue-600 p-3 rounded-2xl border-2 border-white/20 shadow-lg">üîç</div>
                </div>
                <h2 class="text-4xl font-black italic uppercase tracking-tighter mb-2">Cyber Case</h2>
                <p class="text-blue-400 text-[10px] font-bold tracking-[0.3em] mb-8 uppercase opacity-60">High-Tech NFT inside</p>
                <button onclick="startSpin()" class="bg-gradient-to-r from-blue-600 to-blue-400 px-16 py-5 rounded-[2rem] text-xl font-black shadow-[0_10px_30px_-10px_rgba(59,130,246,0.5)] active:scale-95 transition-all">–û–¢–ö–†–´–¢–¨ 100 üíé</button>
            </div>
        </div>
        
        <div class="tab-content">
            <h2 class="text-3xl font-black mb-8 uppercase italic tracking-tighter">Global Market</h2>
            <div id="market-list" class="flex flex-col gap-4"></div>
        </div>

        <div class="tab-content">
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h2 class="text-3xl font-black uppercase italic tracking-tighter leading-none">Vault</h2>
                    <p id="inv-count" class="text-[9px] text-blue-400 font-bold uppercase mt-2 tracking-widest">0 –ø—Ä–µ–¥–º–µ—Ç–æ–≤</p>
                </div>
                <button id="craft-btn" onclick="sendCraft()" class="hidden bg-gradient-to-r from-purple-600 to-fuchsia-500 px-6 py-3 rounded-2xl text-xs font-black animate-bounce shadow-lg shadow-purple-500/30">–ö–†–ê–§–¢ (5/5)</button>
            </div>
            <div id="inv-grid" class="grid grid-cols-2 gap-4"></div>
        </div>

        <div class="tab-content">
            <h2 class="text-3xl font-black mb-8 uppercase italic tracking-tighter text-center">Wall of Fame</h2>
            <div id="top-list" class="glass rounded-[2.5rem] p-6 space-y-5"></div>
        </div>
    </div>

    <div class="fixed bottom-8 left-6 right-6 h-20 glass rounded-[2.5rem] flex justify-around items-center z-50">
        <button onclick="goToTab(0)" id="btn-0" class="nav-btn active">üì¶</button>
        <button onclick="goToTab(1)" id="btn-1" class="nav-btn">üõí</button>
        <button onclick="goToTab(2)" id="btn-2" class="nav-btn">üéí</button>
        <button onclick="goToTab(3)" id="btn-3" class="nav-btn">üèÜ</button>
    </div>

    <div id="case-modal" class="modal-full flex-col items-center justify-center p-6">
        <div class="glass w-full max-w-sm rounded-[3rem] p-8 flex flex-col items-center relative border-t-4 border-blue-500">
            <button onclick="closeModal('case-modal')" class="absolute top-6 right-6 text-gray-500 hover:text-white transition-colors">‚úï</button>
            <h3 class="text-2xl font-black uppercase italic mb-8 text-blue-400">Drops List</h3>
            <div id="modal-items" class="grid grid-cols-2 gap-4 w-full mb-8"></div>
            <button onclick="startSpin(); closeModal('case-modal');" class="w-full bg-blue-600 py-5 rounded-2xl font-black shadow-lg shadow-blue-500/20">–û–¢–ö–†–´–¢–¨</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const user = tg.initDataUnsafe.user || { id: 12345, first_name: "Gamer" };
        const itemsList = [
            { name: "Cyber Cat", rare: "Common", color: "#94a3b8" },
            { name: "Neon Knight", rare: "Rare", color: "#3b82f6" },
            { name: "Glitch Void", rare: "Epic", color: "#a855f7" },
            { name: "Diamond Dragon", rare: "Legendary", color: "#facc15" },
            { name: "Pixel God", rare: "Mythic", color: "#f43f5e" }
        ];
        
        let selectedForCraft = [];

        document.getElementById('u-avatar').src = user.photo_url || `https://api.dicebear.com/7.x/bottts/svg?seed=${user.id}`;

        async function api(path, body = null) {
            try {
                const res = await fetch(window.location.origin + path, {
                    method: body ? 'POST' : 'GET',
                    headers: {"Content-Type": "application/json"},
                    body: body ? JSON.stringify(body) : null
                });
                return await res.json();
            } catch (e) { return null; }
        }

        function openCaseModal() {
            document.getElementById('case-modal').style.display = 'flex';
            document.getElementById('modal-items').innerHTML = itemsList.map(item => `
                <div class="bg-white/5 p-4 rounded-3xl text-center border border-white/5 card-${item.rare}">
                    <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${item.name}" class="w-12 h-12 mx-auto mb-2 drop-shadow-md">
                    <p class="text-[10px] font-black truncate uppercase">${item.name}</p>
                    <p class="text-[8px] font-bold opacity-40 uppercase">${item.rare}</p>
                </div>
            `).join('');
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        async function startSpin() {
            const res = await api('/open_case', {user_id: user.id});
            if(!res?.success) return tg.showAlert(res?.error || "–û—à–∏–±–∫–∞");
            
            const box = document.getElementById('roulette-box');
            const track = document.getElementById('roulette-track');
            document.getElementById('case-ui').style.display = 'none';
            box.style.display = 'block';

            track.innerHTML = Array.from({length: 45}).map((_, i) => {
                const item = (i === 40) ? itemsList.find(x => x.name === res.item) : itemsList[Math.floor(Math.random()*5)];
                return `
                    <div class="roulette-item">
                        <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${item.name}" class="w-20 h-20 drop-shadow-lg">
                        <div class="h-1 w-12 mt-2 rounded-full" style="background: ${item.color}"></div>
                    </div>`;
            }).join('');

            track.style.transition = 'none'; 
            track.style.transform = 'translateX(0px)';
            
            setTimeout(() => {
                track.style.transition = 'transform 4.5s cubic-bezier(0.15, 0, 0.15, 1)';
                const itemWidth = 110;
                const centerOffset = window.innerWidth / 2;
                track.style.transform = `translateX(-${(40 * itemWidth) - centerOffset + (itemWidth/2)}px)`;
            }, 50);

            setTimeout(() => {
                tg.HapticFeedback.notificationOccurred('success');
                box.style.display = 'none'; 
                document.getElementById('case-ui').style.display = 'flex';
                sync();
            }, 5000);
        }

        async function sync() {
            const d = await api(`/get_user?user_id=${user.id}&username=${encodeURIComponent(user.first_name)}`);
            if(!d) return;
            
            document.getElementById('balance').innerText = d.balance.toLocaleString() + " üíé";
            document.getElementById('u-name').innerText = user.first_name;
            document.getElementById('inv-count').innerText = `${d.inventory.length} –ø—Ä–µ–¥–º–µ—Ç–æ–≤`;

            // –†–µ–Ω–¥–µ—Ä –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π —Ä–µ–¥–∫–æ—Å—Ç–∏
            document.getElementById('inv-grid').innerHTML = (d.inventory || []).map((item, idx) => {
                const itemData = itemsList.find(i => i.name === item) || {rare: 'Common'};
                return `
                    <div onclick="toggleCraft('${item}', this, ${idx})" 
                         class="glass p-5 rounded-[2.5rem] text-center fade-in card-${itemData.rare}" 
                         style="animation-delay: ${idx * 0.05}s">
                        <div class="relative mb-3">
                            <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${item}" class="w-20 h-20 mx-auto drop-shadow-xl">
                            <span class="absolute -top-2 -right-2 text-[7px] bg-white/10 px-2 py-1 rounded-full border border-white/10">${itemData.rare}</span>
                        </div>
                        <p class="text-[10px] font-black uppercase tracking-tighter truncate mb-4">${item}</p>
                        <button onclick="event.stopPropagation(); sellItem('${item}')" 
                                class="w-full py-2 bg-white/5 hover:bg-white/10 rounded-xl text-[8px] font-black border border-white/5 transition-all">–ü–†–û–î–ê–¢–¨</button>
                    </div>
                `;
            }).join('') || '<div class="col-span-2 py-20 text-center opacity-20 italic">–ü—É—Å—Ç–æ—Ç–∞...</div>';

            // –ú–∞—Ä–∫–µ—Ç
            const m = await api('/get_market');
            document.getElementById('market-list').innerHTML = m.map(lot => {
                const itemData = itemsList.find(i => i.name === lot.item_name) || {rare: 'Common'};
                return `
                    <div class="glass p-4 rounded-[2rem] flex justify-between items-center fade-in border-l-4 card-${itemData.rare}" style="border-bottom:none">
                        <div class="flex items-center gap-4">
                            <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${lot.item_name}" class="w-12 h-12 drop-shadow-lg">
                            <div>
                                <p class="text-xs font-black uppercase italic">${lot.item_name}</p>
                                <p class="text-[8px] opacity-40 font-bold uppercase tracking-widest">Seller: ${lot.seller_name}</p>
                            </div>
                        </div>
                        ${lot.seller_id == user.id ? 
                            `<button onclick="cancelLot(${lot.lot_id})" class="bg-red-500/10 text-red-500 text-[10px] px-5 py-3 rounded-2xl font-black border border-red-500/20">–°–ù–Ø–¢–¨</button>` : 
                            `<button onclick="buyLot(${lot.lot_id})" class="bg-yellow-400 text-black font-black px-6 py-3 rounded-2xl text-[10px] shadow-lg shadow-yellow-400/20">${lot.price} üíé</button>`
                        }
                    </div>
                `}).join('');

            // –¢–æ–ø
            const top = await api('/get_leaderboard');
            document.getElementById('top-list').innerHTML = top.map((u, i) => `
                <div class="flex justify-between items-center group">
                    <div class="flex items-center gap-3">
                        <span class="w-6 h-6 flex items-center justify-center rounded-lg bg-white/5 text-[10px] font-black">${i+1}</span>
                        <p class="text-sm font-bold uppercase tracking-tight">${u.username}</p>
                    </div>
                    <p class="text-yellow-400 font-black tracking-tighter">${u.balance.toLocaleString()} <span class="text-[10px]">üíé</span></p>
                </div>
            `).join('');
        }

        function toggleCraft(item, el, idx) {
            const pos = selectedForCraft.findIndex(s => s.idx === idx);
            if(pos > -1) {
                selectedForCraft.splice(pos, 1);
                el.classList.remove('selected-for-craft');
            } else if(selectedForCraft.length < 5) {
                selectedForCraft.push({name: item, idx: idx});
                el.classList.add('selected-for-craft');
            }
            document.getElementById('craft-btn').style.display = selectedForCraft.length === 5 ? 'block' : 'none';
        }

        async function sendCraft() {
            tg.HapticFeedback.impactOccurred('medium');
            const res = await api('/craft', {user_id: user.id, items: selectedForCraft.map(s => s.name)});
            if(res.success) {
                tg.showPopup({title: "üî• CRAFTED!", message: `Excellent! You got: ${res.new_item}`});
                selectedForCraft = [];
                sync();
            } else tg.showAlert(res.error);
        }

        function sellItem(i) {
            const p = prompt(`–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ ${i}:`, "500");
            if(p > 0) api('/list_on_market', {user_id: user.id, item: i, price: parseInt(p)}).then(() => {
                tg.HapticFeedback.notificationOccurred('success');
                sync();
            });
        }

        function cancelLot(id) { if(confirm("–°–Ω—è—Ç—å —Å –ø—Ä–æ–¥–∞–∂–∏?")) api('/cancel_lot', {user_id: user.id, lot_id: id}).then(() => sync()); }
        function buyLot(id) { api('/buy_from_market', {user_id: user.id, lot_id: id}).then(() => sync()); }
        
        function goToTab(idx) {
            tg.HapticFeedback.selectionChanged();
            document.getElementById('main-slider').style.transform = `translateX(-${idx * 100}vw)`;
            document.querySelectorAll('.nav-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
            sync();
        }

        setInterval(sync, 15000);
        window.onload = () => { sync(); tg.expand(); };
    </script>
</body>
</html>
