<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NFT Universe</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0b1120; color: white; overflow: hidden; height: 100vh; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); }
        #main-slider { display: flex; transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); width: 400%; height: calc(100vh - 180px); }
        .tab-content { width: 100vw; height: 100%; overflow-y: auto; padding: 20px 20px 100px 20px; flex-shrink: 0; }
        .nav-btn { opacity: 0.4; transition: 0.3s; font-size: 24px; }
        .nav-btn.active { opacity: 1; filter: drop-shadow(0 0 8px #3b82f6); }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫–∞ */
        .notification-active { color: #facc15 !important; filter: drop-shadow(0 0 10px #facc15); animation: ring 1.5s infinite; opacity: 1 !important; }
        @keyframes ring { 0%, 100% { transform: rotate(0); } 15% { transform: rotate(15deg); } 30% { transform: rotate(-15deg); } }
    </style>
</head>
<body class="flex flex-col">
    <div class="p-4 flex justify-between items-center glass m-4 rounded-3xl z-50">
        <div class="flex items-center gap-3">
            <img id="u-avatar" src="" class="w-10 h-10 rounded-full border-2 border-blue-500/50 object-cover bg-slate-800">
            <div>
                <p id="u-name" class="font-bold text-sm leading-none italic">Player</p>
                <p class="text-[9px] text-blue-400 font-bold uppercase mt-1 tracking-wider">Verified Trader</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div id="notif-bell" onclick="checkNotifications()" class="text-xl opacity-50 cursor-pointer transition-all">üîî</div>
            <div class="text-right"><p id="balance" class="text-yellow-400 font-black text-xl">0 üíé</p></div>
        </div>
    </div>

    <div id="main-slider">
        <div class="tab-content flex flex-col items-center">
            <div id="case-display" class="flex flex-col items-center py-10">
                <img src="https://api.dicebear.com/7.x/shapes/svg?seed=case8" class="w-44 h-44 mb-6 drop-shadow-2xl">
                <button onclick="startSpin()" class="bg-blue-600 px-16 py-4 rounded-full text-2xl font-black shadow-xl active:scale-95 transition-all">100 üíé</button>
            </div>
        </div>
        <div class="tab-content"><h2 class="text-2xl font-black mb-6 uppercase italic">Marketplace</h2><div id="market-list" class="flex flex-col gap-3"></div></div>
        <div class="tab-content"><h2 class="text-2xl font-black mb-6 uppercase italic">Collection</h2><div id="inv-grid" class="grid grid-cols-2 gap-4"></div></div>
        <div class="tab-content"><h2 class="text-2xl font-black mb-6 uppercase italic">Top Players</h2><div id="top-list" class="glass rounded-3xl p-4 space-y-4"></div></div>
    </div>

    <div class="fixed bottom-6 left-6 right-6 h-20 glass rounded-[35px] flex justify-around items-center">
        <button onclick="goToTab(0)" id="btn-0" class="nav-btn active">üì¶</button>
        <button onclick="goToTab(1)" id="btn-1" class="nav-btn">üõí</button>
        <button onclick="goToTab(2)" id="btn-2" class="nav-btn">üéí</button>
        <button onclick="goToTab(3)" id="btn-3" class="nav-btn">üèÜ</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const user = tg.initDataUnsafe.user || { id: 877067120, first_name: "Player", photo_url: "" };
        let lastBalance = 0;

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤–∞—Ç–∞—Ä–∞ (–¢–ì –∏–ª–∏ DiceBear)
        const avatarElement = document.getElementById('u-avatar');
        if (user.photo_url) {
            avatarElement.src = user.photo_url;
        } else {
            avatarElement.src = `https://api.dicebear.com/7.x/bottts/svg?seed=${user.id}`;
        }

        async function api(path, body = null) {
            const res = await fetch(window.location.origin + path, {
                method: body ? 'POST' : 'GET',
                headers: {"Content-Type": "application/json"},
                body: body ? JSON.stringify(body) : null
            });
            return res.json();
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫
        function checkNotifications() {
            const bell = document.getElementById('notif-bell');
            if (bell.classList.contains('notification-active')) {
                tg.showAlert("üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í–∞—à –ø—Ä–µ–¥–º–µ—Ç –∫—É–ø–∏–ª–∏. –ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω!");
                bell.classList.remove('notification-active');
            } else {
                tg.showAlert("–ù–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ—Ç. –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Å–∏–≥–Ω–∞–ª, –µ—Å–ª–∏ –∫—É–ø—è—Ç –≤–∞—à –ª–æ—Ç!");
            }
        }

        async function sync() {
            const d = await api(`/get_user?user_id=${user.id}&username=${user.first_name}`);
            
            // –ï—Å–ª–∏ –±–∞–ª–∞–Ω—Å —É–≤–µ–ª–∏—á–∏–ª—Å—è —Å–∞–º –ø–æ —Å–µ–±–µ (–ø—Ä–æ–¥–∞–∂–∞)
            if(lastBalance > 0 && d.balance > lastBalance) {
                document.getElementById('notif-bell').classList.add('notification-active');
                tg.HapticFeedback.notificationOccurred('success');
            }
            
            lastBalance = d.balance;
            document.getElementById('balance').innerText = d.balance.toLocaleString() + " üíé";
            document.getElementById('u-name').innerText = user.first_name;

            // –†–µ–Ω–¥–µ—Ä –ò–Ω–≤–µ–Ω—Ç–∞—Ä—è
            const grid = document.getElementById('inv-grid');
            grid.innerHTML = (d.inventory || []).map(item => `
                <div class="glass p-4 rounded-3xl text-center border-b-4 border-blue-500">
                    <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${item}" class="w-16 h-16 mx-auto mb-2">
                    <p class="text-[10px] font-bold uppercase truncate">${item}</p>
                    <button onclick="sellItem('${item}')" class="mt-2 bg-blue-600 text-[10px] px-3 py-1.5 rounded-full font-bold w-full active:scale-90 transition-transform">–ü–†–û–î–ê–¢–¨</button>
                </div>
            `).join('') || '<p class="col-span-2 text-center opacity-50 py-10">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</p>';

            // –†–µ–Ω–¥–µ—Ä –ú–∞—Ä–∫–µ—Ç–∞
            const mData = await api('/get_market');
            document.getElementById('market-list').innerHTML = mData.map(lot => {
                const isMine = lot.seller_id == user.id;
                return `
                <div class="glass p-3 rounded-2xl flex justify-between items-center border border-white/5">
                    <div class="flex items-center gap-3">
                        <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${lot.item_name}" class="w-10 h-10">
                        <div>
                            <p class="text-xs font-bold leading-none">${lot.item_name}</p>
                            <p class="text-[8px] opacity-40 mt-1 uppercase">–û—Ç: ${lot.seller_name}</p>
                        </div>
                    </div>
                    ${isMine ? 
                        `<button onclick="cancelLot(${lot.lot_id})" class="bg-red-500/20 text-red-400 text-[10px] px-4 py-2 rounded-xl border border-red-500/50 active:scale-90 transition-transform">–°–ù–Ø–¢–¨</button>` : 
                        `<button onclick="buyLot(${lot.lot_id})" class="bg-yellow-500 text-black font-black px-4 py-2 rounded-xl text-xs active:scale-90 transition-transform">${lot.price} üíé</button>`
                    }
                </div>`;
            }).join('') || '<p class="text-center opacity-50 py-10">–†—ã–Ω–æ–∫ –ø—É—Å—Ç</p>';

            const top = await api('/get_leaderboard');
            document.getElementById('top-list').innerHTML = top.map((u, i) => `
                <div class="flex justify-between items-center border-b border-white/5 pb-2">
                    <span class="${u.username === user.first_name ? 'text-blue-400 font-bold' : ''}">${i+1}. ${u.username}</span>
                    <span class="text-yellow-400 font-black">${u.balance.toLocaleString()} üíé</span>
                </div>
            `).join('');
        }

        function sellItem(item) {
            const p = prompt(`–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –ø—Ä–æ–¥–∞–∂–∏ –¥–ª—è ${item}:`, "500");
            if (p && p > 0) {
                api('/list_on_market', {user_id: user.id, item, price: parseInt(p)}).then(res => {
                    if(res.success) sync();
                    else tg.showAlert(res.error);
                });
            }
        }

        function cancelLot(id) {
            if(confirm("–í–µ—Ä–Ω—É—Ç—å –ø—Ä–µ–¥–º–µ—Ç –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å?")) {
                api('/cancel_lot', {user_id: user.id, lot_id: id}).then(() => sync());
            }
        }

        function buyLot(id) {
            api('/buy_from_market', {user_id: user.id, lot_id: id}).then(res => {
                if(res.success) {
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showAlert("‚úÖ –ü—Ä–µ–¥–º–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é!"); 
                    sync(); 
                } else tg.showAlert(res.error);
            });
        }

        async function startSpin() {
            const res = await api('/open_case', {user_id: user.id});
            if(res.success) {
                tg.HapticFeedback.impactOccurred('heavy');
                tg.showAlert("üî• –í—ã –ø–æ–ª—É—á–∏–ª–∏: " + res.item); 
                sync(); 
            } else tg.showAlert(res.error);
        }

        function goToTab(idx) {
            document.getElementById('main-slider').style.transform = `translateX(-${idx * 100}vw)`;
            document.querySelectorAll('.nav-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
            
            // –ï—Å–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Ä—ã–Ω–∫–∞ –∏–ª–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫–∞
            if(idx === 1 || idx === 2) {
                // –ù–æ –ª—É—á—à–µ –æ—Å—Ç–∞–≤–∏—Ç—å —Å–±—Ä–æ—Å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å–∞–º –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫ (—Ñ—É–Ω–∫—Ü–∏—è –≤—ã—à–µ)
            }
            sync();
        }

        setInterval(sync, 10000); 
        window.onload = sync;
        tg.expand();
    </script>
</body>
</html>
