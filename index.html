<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NFT Universe Elite</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0b1120; color: white; overflow: hidden; }
        .glass { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.08); }
        #main-slider { display: flex; transition: transform 0.4s ease-out; width: 400%; height: 100vh; }
        .tab-content { width: 100vw; height: 100vh; overflow-y: auto; padding: 20px 20px 120px 20px; flex-shrink: 0; }
        #toast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); z-index: 20000; transition: 0.5s; width: 90%; }
        #toast.show { top: 20px; }
        .nav-btn { transition: 0.3s; opacity: 0.4; font-size: 24px; }
        .nav-btn.active { opacity: 1; transform: scale(1.2); }
        #win-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; }
    </style>
</head>
<body class="flex flex-col">

    <div id="toast" class="glass px-6 py-4 rounded-2xl flex items-center gap-3 border-b-2 border-blue-500">
        <span id="toast-icon">‚ú®</span>
        <span id="toast-msg" class="font-bold"></span>
    </div>

    <div id="win-modal" class="p-6">
        <div class="glass p-8 rounded-[40px] w-full max-w-sm text-center border-t-4 border-yellow-500">
            <h2 class="text-2xl font-black text-yellow-500 uppercase italic">–í—ã–ø–∞–ª NFT!</h2>
            <div id="win-item-img" class="my-6"></div>
            <h3 id="win-item-name" class="text-xl font-bold mb-6 uppercase">...</h3>
            <button onclick="closeWinModal()" class="w-full bg-blue-600 py-4 rounded-2xl font-black uppercase mb-3">–í —Ä—é–∫–∑–∞–∫</button>
            <button id="quick-sell-btn" class="w-full bg-white/10 py-3 rounded-2xl text-xs font-bold text-gray-400">–ü—Ä–æ–¥–∞—Ç—å –∑–∞ 80 üíé</button>
        </div>
    </div>

    <div class="p-4 flex justify-between items-center glass m-2 rounded-3xl z-50">
        <div class="flex items-center gap-3">
            <div id="u-avatar" class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold overflow-hidden"></div>
            <p id="u-name" class="font-bold text-sm">...</p>
        </div>
        <p id="balance" class="text-yellow-400 font-black text-xl">0 üíé</p>
    </div>

    <div class="flex-1 overflow-hidden">
        <div id="main-slider">
            <div class="tab-content flex flex-col items-center justify-center">
                <div onclick="openCase()" class="glass p-10 rounded-[50px] border-b-[10px] border-blue-600 active:scale-95 transition-all text-center">
                    <div class="text-8xl mb-4">üì¶</div>
                    <h3 class="text-2xl font-black uppercase">Cyber Case</h3>
                    <div class="bg-blue-600 py-3 rounded-2xl font-black mt-6">100 üíé</div>
                </div>
            </div>
            
            <div class="tab-content">
                <h2 class="text-xl font-black mb-4 text-blue-400">üõí –ú–ê–†–ö–ï–¢</h2>
                <div id="market-list" class="flex flex-col gap-3 text-center text-gray-500 italic py-10">–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ...</div>
            </div>

            <div class="tab-content">
                <h2 class="text-xl font-black mb-4 text-blue-400">üéí –ú–û–ô –†–Æ–ö–ó–ê–ö</h2>
                <div id="inv-grid" class="grid grid-cols-2 gap-3"></div>
            </div>

            <div class="tab-content">
                <h2 class="text-xl font-black mb-4 text-yellow-500">üèÜ –¢–û–ü –ò–ì–†–û–ö–û–í</h2>
                <div id="top-list" class="flex flex-col gap-2"></div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-6 left-4 right-4 h-20 glass rounded-[35px] flex justify-around items-center z-50">
        <button onclick="goToTab(0)" id="btn-0" class="nav-btn active">üì¶</button>
        <button onclick="goToTab(1)" id="btn-1" class="nav-btn">üõí</button>
        <button onclick="goToTab(2)" id="btn-2" class="nav-btn">üéí</button>
        <button onclick="goToTab(3)" id="btn-3" class="nav-btn">üèÜ</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // --- –ó–ê–ú–ï–ù–ò –≠–¢–û–¢ URL –ù–ê –°–í–û–ô –ò–ó NGROK ---
        const SERVER_URL = "https://–í–ê–®_NGROK_URL"; 
        
        const user = tg.initDataUnsafe.user || { id: 12345, first_name: "–ò–≥—Ä–æ–∫", photo_url: "" };
        const fetchHeaders = { "Content-Type": "application/json", "ngrok-skip-browser-warning": "true" };

        function showToast(msg, icon = '‚ú®') {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            document.getElementById('toast-icon').innerText = icon;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        async function sync() {
            try {
                const url = `${SERVER_URL}/get_user?user_id=${user.id}&username=${encodeURIComponent(user.first_name)}&photo_url=${encodeURIComponent(user.photo_url || "")}`;
                const res = await fetch(url, { headers: fetchHeaders });
                const d = await res.json();
                
                document.getElementById('balance').innerText = d.balance.toLocaleString() + " üíé";
                document.getElementById('u-name').innerText = user.first_name;
                
                // –ê–≤–∞—Ç–∞—Ä–∫–∞
                const avatar = document.getElementById('u-avatar');
                if(user.photo_url) avatar.innerHTML = `<img src="${user.photo_url}" class="w-full h-full object-cover">`;
                else avatar.innerText = user.first_name[0].toUpperCase();

                // –†—é–∫–∑–∞–∫
                const grid = document.getElementById('inv-grid');
                if(!d.inventory || d.inventory.length === 0) {
                    grid.innerHTML = '<p class="col-span-2 text-center text-gray-500 py-10 italic">–ü—É—Å—Ç–æ</p>';
                } else {
                    grid.innerHTML = d.inventory.map(item => `
                        <div class="glass p-4 rounded-3xl text-center border-b-4 border-blue-500/30">
                            <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${item}" class="w-16 h-16 mx-auto mb-2">
                            <p class="text-[10px] font-black uppercase mb-3 truncate">${item}</p>
                            <button onclick="sellItem('${item}')" class="w-full bg-blue-600/20 text-blue-400 py-2 rounded-xl text-[10px] font-black uppercase active:scale-95 transition-all">–ü—Ä–æ–¥–∞—Ç—å</button>
                        </div>
                    `).join('');
                }
            } catch(e) { console.error(e); }
        }

        async function openCase() {
            tg.HapticFeedback.impactOccurred('medium');
            try {
                const res = await fetch(`${SERVER_URL}/open_case`, {
                    method: 'POST',
                    headers: fetchHeaders,
                    body: JSON.stringify({ user_id: user.id })
                });
                const data = await res.json();
                if(data.success) {
                    document.getElementById('win-item-name').innerText = data.item;
                    document.getElementById('win-item-img').innerHTML = `<img src="https://api.dicebear.com/7.x/bottts/svg?seed=${data.item}" class="w-32 h-32 mx-auto">`;
                    document.getElementById('quick-sell-btn').onclick = () => sellItem(data.item, true);
                    document.getElementById('win-modal').style.display = 'flex';
                } else {
                    showToast(data.error, "‚ùå");
                }
            } catch(e) { showToast("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞", "üì°"); }
        }

        async function sellItem(itemName, fromModal = false) {
            tg.HapticFeedback.notificationOccurred('success');
            try {
                const res = await fetch(`${SERVER_URL}/sell_instantly`, {
                    method: 'POST',
                    headers: fetchHeaders,
                    body: JSON.stringify({ user_id: user.id, item_name: itemName })
                });
                const data = await res.json();
                if(data.success) {
                    showToast(`–ü—Ä–æ–¥–∞–Ω–æ! +${data.new_balance} üíé`, "üí∞");
                    if(fromModal) closeWinModal();
                    await sync();
                }
            } catch(e) { showToast("–û—à–∏–±–∫–∞ –ø—Ä–æ–¥–∞–∂–∏", "‚ùå"); }
        }

        async function loadTop() {
            try {
                const res = await fetch(`${SERVER_URL}/get_top`, { headers: fetchHeaders });
                const users = await res.json();
                document.getElementById('top-list').innerHTML = users.map((u, i) => `
                    <div class="glass p-4 rounded-2xl flex justify-between items-center ${u.user_id == user.id ? 'border border-blue-400' : ''}">
                        <div class="flex items-center gap-3">
                            <span class="font-black text-gray-500 w-6">#${i+1}</span>
                            <div class="w-8 h-8 rounded-full bg-blue-900 flex items-center justify-center text-[10px] overflow-hidden">
                                ${u.photo_url ? `<img src="${u.photo_url}">` : (u.username ? u.username[0] : '?')}
                            </div>
                            <p class="text-sm font-bold truncate w-32">${u.username || '–ê–Ω–æ–Ω–∏–º'}</p>
                        </div>
                        <p class="font-black text-yellow-400">${u.balance.toLocaleString()} üíé</p>
                    </div>
                `).join('');
            } catch(e) {}
        }

        function goToTab(i) {
            document.getElementById('main-slider').style.transform = `translateX(-${i * 100}vw)`;
            document.querySelectorAll('.nav-btn').forEach((btn, idx) => {
                btn.classList.toggle('active', idx === i);
            });
            if(i === 2) sync();
            if(i === 3) loadTop();
            tg.HapticFeedback.impactOccurred('light');
        }

        function closeWinModal() { document.getElementById('win-modal').style.display = 'none'; sync(); }

        // –ó–∞–ø—É—Å–∫
        sync();
    </script>
</body>
</html>
