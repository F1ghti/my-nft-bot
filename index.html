<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NFT Universe</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0b1120; color: white; overflow: hidden; height: 100vh; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(15px); border: 1px solid rgba(255,255,255,0.1); }
        #main-slider { display: flex; transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); width: 400%; height: calc(100vh - 180px); }
        .tab-content { width: 100vw; height: 100%; overflow-y: auto; padding: 20px 20px 100px 20px; flex-shrink: 0; }
        .nav-btn { opacity: 0.4; transition: 0.3s; font-size: 24px; }
        .nav-btn.active { opacity: 1; filter: drop-shadow(0 0 8px #3b82f6); }
        .roulette-wrapper { position: relative; width: 100%; height: 130px; overflow: hidden; margin-bottom: 20px; display: none; }
        .roulette-track { display: flex; position: absolute; left: 0; transition: transform 4s cubic-bezier(0.15, 0, 0.15, 1); }
        .roulette-item { width: 100px; height: 130px; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.05); background: rgba(255,255,255,0.02); }
        .pointer { position: absolute; left: 50%; top: 0; bottom: 0; width: 2px; background: #3b82f6; z-index: 20; box-shadow: 0 0 15px #3b82f6; }
    </style>
</head>
<body class="flex flex-col">
    <div class="p-4 flex justify-between items-center glass m-4 rounded-3xl z-50">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center font-bold">?</div>
            <div>
                <p id="u-name" class="font-bold text-sm leading-none italic">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                <p class="text-[9px] text-blue-400 font-bold uppercase mt-1 tracking-widest tracking-tighter">Member</p>
            </div>
        </div>
        <div class="text-right"><p id="balance" class="text-yellow-400 font-black text-xl">0 üíé</p></div>
    </div>

    <div id="main-slider">
        <div class="tab-content flex flex-col items-center">
            <div id="roulette-box" class="roulette-wrapper glass rounded-2xl"><div class="pointer"></div><div id="roulette-track" class="roulette-track"></div></div>
            <div id="case-display" class="flex flex-col items-center">
                <img src="https://api.dicebear.com/7.x/shapes/svg?seed=case8" class="w-44 h-44 mb-4 drop-shadow-2xl">
                <h2 class="text-3xl font-black italic uppercase tracking-tighter">Cyber Case</h2>
                <button onclick="startSpin()" class="mt-6 bg-blue-600 px-16 py-4 rounded-full text-2xl font-black shadow-xl active:scale-95 transition-all">100 üíé</button>
            </div>
        </div>
        <div class="tab-content">
            <h2 class="text-2xl font-black mb-6 italic uppercase">Marketplace</h2>
            <div id="market-list" class="flex flex-col gap-3"></div>
        </div>
        <div class="tab-content">
            <h2 class="text-2xl font-black mb-6 italic uppercase">Inventory</h2>
            <div id="inv-grid" class="grid grid-cols-2 gap-4"></div>
        </div>
        <div class="tab-content">
            <h2 class="text-2xl font-black mb-6 italic uppercase">Leaderboard</h2>
            <div id="top-list" class="glass rounded-3xl p-4 space-y-4"></div>
        </div>
    </div>

    <div class="fixed bottom-6 left-6 right-6 h-20 glass rounded-[35px] flex justify-around items-center z-[1000]">
        <button onclick="goToTab(0)" id="btn-0" class="nav-btn active">üì¶</button>
        <button onclick="goToTab(1)" id="btn-1" class="nav-btn">üõí</button>
        <button onclick="goToTab(2)" id="btn-2" class="nav-btn">üéí</button>
        <button onclick="goToTab(3)" id="btn-3" class="nav-btn">üèÜ</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        const SERVER_URL = window.location.origin;
        const user = tg.initDataUnsafe.user || { id: 877067120, first_name: "Player" };
        const itemsList = ["Cyber Cat", "Neon Knight", "Glitch Void", "Diamond Dragon", "Pixel God"];

        async function api(path, body = null) {
            try {
                const opt = { 
                    method: body ? 'POST' : 'GET', 
                    headers: { "Content-Type": "application/json", "ngrok-skip-browser-warning": "1" } 
                };
                if(body) opt.body = JSON.stringify(body);
                const res = await fetch(SERVER_URL + path, opt);
                return await res.json();
            } catch(e) { return null; }
        }

        async function sync() {
            const d = await api(`/get_user?user_id=${user.id}&username=${encodeURIComponent(user.first_name)}`);
            if(!d) return;
            
            document.getElementById('balance').innerText = d.balance.toLocaleString() + " üíé";
            document.getElementById('u-name').innerText = user.first_name;
            
            // Inventory
            const grid = document.getElementById('inv-grid');
            grid.innerHTML = (d.inventory || []).map(item => `
                <div class="glass p-4 rounded-3xl text-center border-b-4 border-blue-500">
                    <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${item}" class="w-16 h-16 mx-auto mb-2">
                    <p class="text-[10px] font-bold uppercase mb-2 truncate">${item}</p>
                    <button onclick="listOnMarket('${item}')" class="bg-blue-600 text-[9px] px-3 py-1.5 rounded-full font-bold w-full">–í–´–°–¢–ê–í–ò–¢–¨</button>
                </div>
            `).join('') || '<p class="col-span-2 text-center text-gray-500 py-10">–ü—É—Å—Ç–æ</p>';

            // Market
            const marketData = await api('/get_market');
            const mList = document.getElementById('market-list');
            mList.innerHTML = (marketData || []).map(lot => `
                <div class="glass p-3 rounded-2xl flex justify-between items-center border border-white/5">
                    <div class="flex items-center gap-3">
                        <img src="https://api.dicebear.com/7.x/bottts/svg?seed=${lot.item_name}" class="w-10 h-10 rounded-lg">
                        <div><p class="text-xs font-bold leading-none">${lot.item_name}</p><p class="text-[8px] text-gray-400 mt-1 uppercase">–û—Ç: ${lot.seller_name}</p></div>
                    </div>
                    <button onclick="buyItem(${lot.lot_id})" class="bg-yellow-500 text-black font-black px-4 py-2 rounded-xl text-xs">${lot.price} üíé</button>
                </div>
            `).join('') || '<p class="text-center text-gray-500 py-10">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</p>';

            // Top
            const top = await api('/get_leaderboard');
            if(top) document.getElementById('top-list').innerHTML = top.map((u, i) => `<div class="flex justify-between items-center border-b border-white/5 pb-2"><span class="text-sm font-bold">${i+1}. ${u.username}</span><span class="text-yellow-400 font-black">${u.balance} üíé</span></div>`).join('');
        }

        // --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –í–´–°–¢–ê–í–õ–ï–ù–ò–Ø ---
        function listOnMarket(itemName) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π prompt –±—Ä–∞—É–∑–µ—Ä–∞ –≤–º–µ—Å—Ç–æ tg.showPrompt
    const price = prompt(`–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –ø—Ä–æ–¥–∞–∂–∏ –¥–ª—è ${itemName}:`, "100");
    
    if (price === null || price === "") return; // –ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ "–û—Ç–º–µ–Ω–∞"
    
    const p = parseInt(price);
    if (isNaN(p) || p <= 0) {
        alert("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –±–æ–ª—å—à–µ 0!");
        return;
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    api('/list_on_market', {
        user_id: user.id, 
        item: itemName, 
        price: p
    }).then(res => {
        if(res && res.success) {
            tg.HapticFeedback.notificationOccurred('success');
            alert("‚úÖ –í—ã—Å—Ç–∞–≤–ª–µ–Ω–æ!");
            sync();
        } else {
            alert("‚ùå " + (res ? res.error : "–û—à–∏–±–∫–∞"));
        }
    });
}
        }

        async function buyItem(lotId) {
            const res = await api('/buy_from_market', {user_id: user.id, lot_id: lotId});
            if(res && res.success) {
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert("–ö—É–ø–ª–µ–Ω–æ!"); 
                sync(); 
            } else tg.showAlert(res ? res.error : "–û—à–∏–±–∫–∞");
        }

        async function startSpin() {
            const res = await api('/open_case', {user_id: user.id});
            if(!res || !res.success) return tg.showAlert(res ? res.error : "–ù–µ—Ç üíé");
            
            const box = document.getElementById('roulette-box');
            const track = document.getElementById('roulette-track');
            const caseDisplay = document.getElementById('case-display');
            
            caseDisplay.style.display = 'none'; 
            box.style.display = 'block';
            
            let html = "";
            for(let i=0; i<45; i++) {
                const item = (i === 40) ? res.item : itemsList[Math.floor(Math.random()*itemsList.length)];
                html += `<div class="roulette-item"><img src="https://api.dicebear.com/7.x/bottts/svg?seed=${item}" class="w-12 h-12"></div>`;
            }
            track.innerHTML = html; 
            track.style.transform = 'translateX(0px)';
            
            setTimeout(() => {
                track.style.transform = `translateX(-${40 * 100 - (window.innerWidth / 2) + 50}px)`;
                tg.HapticFeedback.impactOccurred('medium');
            }, 50);
            
            setTimeout(() => { 
                tg.showAlert("–í—ã–ø–∞–ª–æ: " + res.item); 
                box.style.display = 'none'; 
                caseDisplay.style.display = 'flex'; 
                sync(); 
            }, 4500);
        }

        function goToTab(idx) {
            document.getElementById('main-slider').style.transform = `translateX(-${idx * 100}vw)`;
            document.querySelectorAll('.nav-btn').forEach((b, i) => b.classList.toggle('active', i === idx));
            sync();
        }

        window.onload = sync;
    </script>
</body>
</html>
